<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JsoniterSpi.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">json iterator</a> &gt; <a href="index.source.html" class="el_package">com.jsoniter.spi</a> &gt; <span class="el_source">JsoniterSpi.java</span></div><h1>JsoniterSpi.java</h1><pre class="source lang-java linenums">package com.jsoniter.spi;

import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

<span class="nc" id="L9">public class JsoniterSpi {</span>

    // registered at startup, global state
    private static Config defaultConfig;
<span class="fc" id="L13">    private static List&lt;Extension&gt; extensions = new ArrayList&lt;Extension&gt;();</span>
<span class="fc" id="L14">    private static Map&lt;Class, Class&gt; typeImpls = new HashMap&lt;Class, Class&gt;();</span>
<span class="fc" id="L15">    private static Map&lt;Type, Decoder&gt; globalMapKeyDecoders = new HashMap&lt;Type, Decoder&gt;();</span>
<span class="fc" id="L16">    private static Map&lt;Type, Encoder&gt; globalMapKeyEncoders = new HashMap&lt;Type, Encoder&gt;();</span>
<span class="fc" id="L17">    private static Map&lt;Type, Decoder&gt; globalTypeDecoders = new HashMap&lt;Type, Decoder&gt;();</span>
<span class="fc" id="L18">    private static Map&lt;Type, Encoder&gt; globalTypeEncoders = new HashMap&lt;Type, Encoder&gt;();</span>
<span class="fc" id="L19">    private static Map&lt;TypeProperty, Decoder&gt; globalPropertyDecoders = new HashMap&lt;TypeProperty, Decoder&gt;();</span>
<span class="fc" id="L20">    private static Map&lt;TypeProperty, Encoder&gt; globalPropertyEncoders = new HashMap&lt;TypeProperty, Encoder&gt;();</span>

    // current state
<span class="fc" id="L23">    private static ThreadLocal&lt;Config&gt; currentConfig = new ThreadLocal&lt;Config&gt;() {</span>
        @Override
        protected Config initialValue() {
<span class="fc" id="L26">            return defaultConfig;</span>
        }
    };
<span class="fc" id="L29">    private static volatile Map&lt;Object, String&gt; configNames = new HashMap&lt;Object, String&gt;();</span>
<span class="fc" id="L30">    private static volatile Map&lt;String, Encoder&gt; mapKeyEncoders = new HashMap&lt;String, Encoder&gt;();</span>
<span class="fc" id="L31">    private static volatile Map&lt;String, Decoder&gt; mapKeyDecoders = new HashMap&lt;String, Decoder&gt;();</span>
<span class="fc" id="L32">    private static volatile Map&lt;String, Encoder&gt; encoders = new HashMap&lt;String, Encoder&gt;();</span>
<span class="fc" id="L33">    private static volatile Map&lt;String, Decoder&gt; decoders = new HashMap&lt;String, Decoder&gt;();</span>
<span class="fc" id="L34">    private static volatile Map&lt;Class, Extension&gt; objectFactories = new HashMap&lt;Class, Extension&gt;();</span>

    static {
<span class="fc" id="L37">        defaultConfig = Config.INSTANCE;</span>
<span class="fc" id="L38">    }</span>

    // === global ===

    public static void setCurrentConfig(Config val) {
<span class="fc" id="L43">        currentConfig.set(val);</span>
<span class="fc" id="L44">    }</span>

    // TODO usage of this method leads to potentially unexpected side effects. All usage should be checked.
    public static void clearCurrentConfig() {
<span class="fc" id="L48">        currentConfig.set(defaultConfig);</span>
<span class="fc" id="L49">    }</span>

    public static Config getCurrentConfig() {
<span class="fc" id="L52">        return currentConfig.get();</span>
    }

    public static void setDefaultConfig(Config val) {
<span class="fc" id="L56">        defaultConfig = val;</span>
<span class="fc" id="L57">    }</span>

    public static Config getDefaultConfig() {
<span class="fc" id="L60">        return defaultConfig;</span>
    }

    public static String assignConfigName(Object obj) {
<span class="fc" id="L64">        String configName = configNames.get(obj);</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">        if (configName != null) {</span>
<span class="fc" id="L66">            return configName;</span>
        }
<span class="fc" id="L68">        return assignNewConfigName(obj);</span>
    }

    private synchronized static String assignNewConfigName(Object obj) {
<span class="fc" id="L72">        String configName = configNames.get(obj);</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        if (configName != null) {</span>
<span class="nc" id="L74">            return configName;</span>
        }

<span class="fc" id="L77">        long hash = obj.toString().hashCode();</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">        if (hash &lt; 0) {</span>
<span class="fc" id="L79">            hash = Long.MAX_VALUE + hash;</span>
        }
<span class="fc" id="L81">        configName = &quot;jsoniter_codegen.cfg&quot; + hash + &quot;.&quot;;</span>
<span class="fc" id="L82">        copyGlobalSettings(configName);</span>
<span class="fc" id="L83">        HashMap&lt;Object, String&gt; newCache = new HashMap&lt;Object, String&gt;(configNames);</span>
<span class="fc" id="L84">        newCache.put(obj, configName);</span>
<span class="fc" id="L85">        configNames = newCache;</span>
<span class="fc" id="L86">        return configName;</span>
    }

    public static void registerExtension(Extension extension) {
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (!extensions.contains(extension)) {</span>
<span class="fc" id="L91">            extensions.add(extension);</span>
        }
<span class="fc" id="L93">    }</span>

    // TODO: use composite pattern
    public static List&lt;Extension&gt; getExtensions() {
<span class="fc" id="L97">        ArrayList&lt;Extension&gt; combined = new ArrayList&lt;Extension&gt;(extensions);</span>
<span class="fc" id="L98">        combined.add(currentConfig.get());</span>
<span class="fc" id="L99">        return combined;</span>
    }

    public static void registerMapKeyDecoder(Type mapKeyType, Decoder mapKeyDecoder) {
<span class="fc" id="L103">        globalMapKeyDecoders.put(mapKeyType, mapKeyDecoder);</span>
<span class="fc" id="L104">        copyGlobalMapKeyDecoder(getCurrentConfig().configName(), mapKeyType, mapKeyDecoder);</span>
<span class="fc" id="L105">    }</span>

    public static void registerMapKeyEncoder(Type mapKeyType, Encoder mapKeyEncoder) {
<span class="fc" id="L108">        globalMapKeyEncoders.put(mapKeyType, mapKeyEncoder);</span>
<span class="fc" id="L109">        copyGlobalMapKeyEncoder(getCurrentConfig().configName(), mapKeyType, mapKeyEncoder);</span>
<span class="fc" id="L110">    }</span>

    public static void registerTypeImplementation(Class superClazz, Class implClazz) {
<span class="fc" id="L113">        typeImpls.put(superClazz, implClazz);</span>
<span class="fc" id="L114">    }</span>

    public static Class getTypeImplementation(Class superClazz) {
<span class="fc" id="L117">        return typeImpls.get(superClazz);</span>
    }

    public static void registerTypeDecoder(Class clazz, Decoder decoder) {
<span class="fc" id="L121">        globalTypeDecoders.put(clazz, decoder);</span>
<span class="fc" id="L122">        copyGlobalTypeDecoder(getCurrentConfig().configName(), clazz, decoder);</span>
<span class="fc" id="L123">    }</span>

    public static void registerTypeDecoder(TypeLiteral typeLiteral, Decoder decoder) {
<span class="fc" id="L126">        globalTypeDecoders.put(typeLiteral.getType(), decoder);</span>
<span class="fc" id="L127">        copyGlobalTypeDecoder(getCurrentConfig().configName(), typeLiteral.getType(), decoder);</span>
<span class="fc" id="L128">    }</span>

    public static void registerTypeEncoder(Class clazz, Encoder encoder) {
<span class="fc" id="L131">        globalTypeEncoders.put(clazz, encoder);</span>
<span class="fc" id="L132">        copyGlobalTypeEncoder(getCurrentConfig().configName(), clazz, encoder);</span>
<span class="fc" id="L133">    }</span>

    public static void registerTypeEncoder(TypeLiteral typeLiteral, Encoder encoder) {
<span class="fc" id="L136">        globalTypeEncoders.put(typeLiteral.getType(), encoder);</span>
<span class="fc" id="L137">        copyGlobalTypeEncoder(getCurrentConfig().configName(), typeLiteral.getType(), encoder);</span>
<span class="fc" id="L138">    }</span>

    public static void registerPropertyDecoder(Class clazz, String property, Decoder decoder) {
<span class="fc" id="L141">        globalPropertyDecoders.put(new TypeProperty(clazz, property), decoder);</span>
<span class="fc" id="L142">        copyGlobalPropertyDecoder(getCurrentConfig().configName(), clazz, property, decoder);</span>
<span class="fc" id="L143">    }</span>

    public static void registerPropertyDecoder(TypeLiteral typeLiteral, String property, Decoder decoder) {
<span class="fc" id="L146">        globalPropertyDecoders.put(new TypeProperty(typeLiteral.getType(), property), decoder);</span>
<span class="fc" id="L147">        copyGlobalPropertyDecoder(getCurrentConfig().configName(), typeLiteral.getType(), property, decoder);</span>
<span class="fc" id="L148">    }</span>

    public static void registerPropertyEncoder(Class clazz, String property, Encoder encoder) {
<span class="fc" id="L151">        globalPropertyEncoders.put(new TypeProperty(clazz, property), encoder);</span>
<span class="fc" id="L152">        copyGlobalPropertyEncoder(getCurrentConfig().configName(), clazz, property, encoder);</span>
<span class="fc" id="L153">    }</span>

    public static void registerPropertyEncoder(TypeLiteral typeLiteral, String property, Encoder encoder) {
<span class="fc" id="L156">        globalPropertyEncoders.put(new TypeProperty(typeLiteral.getType(), property), encoder);</span>
<span class="fc" id="L157">        copyGlobalPropertyEncoder(getCurrentConfig().configName(), typeLiteral.getType(), property, encoder);</span>
<span class="fc" id="L158">    }</span>

    // === copy from global to current ===

    private static void copyGlobalSettings(String configName) {
<span class="fc bfc" id="L163" title="All 2 branches covered.">        for (Map.Entry&lt;Type, Decoder&gt; entry : globalMapKeyDecoders.entrySet()) {</span>
<span class="fc" id="L164">            copyGlobalMapKeyDecoder(configName, entry.getKey(), entry.getValue());</span>
<span class="fc" id="L165">        }</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">        for (Map.Entry&lt;Type, Encoder&gt; entry : globalMapKeyEncoders.entrySet()) {</span>
<span class="fc" id="L167">            copyGlobalMapKeyEncoder(configName, entry.getKey(), entry.getValue());</span>
<span class="fc" id="L168">        }</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        for (Map.Entry&lt;Type, Decoder&gt; entry : globalTypeDecoders.entrySet()) {</span>
<span class="fc" id="L170">            copyGlobalTypeDecoder(configName, entry.getKey(), entry.getValue());</span>
<span class="fc" id="L171">        }</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">        for (Map.Entry&lt;Type, Encoder&gt; entry : globalTypeEncoders.entrySet()) {</span>
<span class="fc" id="L173">            copyGlobalTypeEncoder(configName, entry.getKey(), entry.getValue());</span>
<span class="fc" id="L174">        }</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">        for (Map.Entry&lt;TypeProperty, Decoder&gt; entry : globalPropertyDecoders.entrySet()) {</span>
<span class="fc" id="L176">            copyGlobalPropertyDecoder(configName, entry.getKey().type, entry.getKey().property, entry.getValue());</span>
<span class="fc" id="L177">        }</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">        for (Map.Entry&lt;TypeProperty, Encoder&gt; entry : globalPropertyEncoders.entrySet()) {</span>
<span class="fc" id="L179">            copyGlobalPropertyEncoder(configName, entry.getKey().type, entry.getKey().property, entry.getValue());</span>

<span class="fc" id="L181">        }</span>
<span class="fc" id="L182">    }</span>

    private static void copyGlobalPropertyEncoder(String configName, Type type, String property, Encoder propertyEncoder) {
<span class="fc" id="L185">        addNewEncoder(property + &quot;@&quot; + TypeLiteral.create(type).getEncoderCacheKey(), propertyEncoder);</span>
<span class="fc" id="L186">    }</span>

    private static void copyGlobalPropertyDecoder(String configName, Type type, String property, Decoder propertyDecoder) {
<span class="fc" id="L189">        addNewDecoder(property + &quot;@&quot; + TypeLiteral.create(type).getDecoderCacheKey(), propertyDecoder);</span>
<span class="fc" id="L190">    }</span>

    private static void copyGlobalTypeEncoder(String configName, Type type, Encoder typeEncoder) {
<span class="fc" id="L193">        addNewEncoder(TypeLiteral.create(type).getEncoderCacheKey(configName), typeEncoder);</span>
<span class="fc" id="L194">    }</span>

    private static void copyGlobalTypeDecoder(String configName, Type type, Decoder typeDecoder) {
<span class="fc" id="L197">        addNewDecoder(TypeLiteral.create(type).getDecoderCacheKey(configName), typeDecoder);</span>
<span class="fc" id="L198">    }</span>

    private static void copyGlobalMapKeyDecoder(String configName, Type mapKeyType, Decoder mapKeyDecoder) {
<span class="fc" id="L201">        addNewMapDecoder(TypeLiteral.create(mapKeyType).getDecoderCacheKey(configName), mapKeyDecoder);</span>
<span class="fc" id="L202">    }</span>

    private static void copyGlobalMapKeyEncoder(String configName, Type mapKeyType, Encoder mapKeyEncoder) {
<span class="fc" id="L205">        addNewMapEncoder(TypeLiteral.create(mapKeyType).getEncoderCacheKey(configName), mapKeyEncoder);</span>
<span class="fc" id="L206">    }</span>

    public static String getMapKeyEncoderCacheKey(Type mapKeyType) {
<span class="fc" id="L209">        TypeLiteral typeLiteral = TypeLiteral.create(mapKeyType);</span>
<span class="fc" id="L210">        return typeLiteral.getEncoderCacheKey();</span>
    }

    public static String getMapKeyDecoderCacheKey(Type mapKeyType) {
<span class="fc" id="L214">        TypeLiteral typeLiteral = TypeLiteral.create(mapKeyType);</span>
<span class="fc" id="L215">        return typeLiteral.getDecoderCacheKey();</span>
    }

    // === current ===

    public synchronized static void addNewMapDecoder(String cacheKey, Decoder mapKeyDecoder) {
<span class="fc" id="L221">        HashMap&lt;String, Decoder&gt; newCache = new HashMap&lt;String, Decoder&gt;(mapKeyDecoders);</span>
<span class="fc" id="L222">        newCache.put(cacheKey, mapKeyDecoder);</span>
<span class="fc" id="L223">        mapKeyDecoders = newCache;</span>
<span class="fc" id="L224">    }</span>

    public static Decoder getMapKeyDecoder(String cacheKey) {
<span class="fc" id="L227">        return mapKeyDecoders.get(cacheKey);</span>
    }

    public synchronized static void addNewMapEncoder(String cacheKey, Encoder mapKeyEncoder) {
<span class="fc" id="L231">        HashMap&lt;String, Encoder&gt; newCache = new HashMap&lt;String, Encoder&gt;(mapKeyEncoders);</span>
<span class="fc" id="L232">        newCache.put(cacheKey, mapKeyEncoder);</span>
<span class="fc" id="L233">        mapKeyEncoders = newCache;</span>
<span class="fc" id="L234">    }</span>

    public static Encoder getMapKeyEncoder(String cacheKey) {
<span class="fc" id="L237">        return mapKeyEncoders.get(cacheKey);</span>
    }

    public static Decoder getDecoder(String cacheKey) {
<span class="fc" id="L241">        return decoders.get(cacheKey);</span>
    }

    public synchronized static void addNewDecoder(String cacheKey, Decoder decoder) {
<span class="fc" id="L245">        HashMap&lt;String, Decoder&gt; newCache = new HashMap&lt;String, Decoder&gt;(decoders);</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">        if (decoder == null) {</span>
<span class="fc" id="L247">            newCache.remove(cacheKey);</span>
        } else {
<span class="fc" id="L249">            newCache.put(cacheKey, decoder);</span>
        }
<span class="fc" id="L251">        decoders = newCache;</span>
<span class="fc" id="L252">    }</span>

    public static Encoder getEncoder(String cacheKey) {
<span class="fc" id="L255">        return encoders.get(cacheKey);</span>
    }

    public synchronized static void addNewEncoder(String cacheKey, Encoder encoder) {
<span class="fc" id="L259">        HashMap&lt;String, Encoder&gt; newCache = new HashMap&lt;String, Encoder&gt;(encoders);</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">        if (encoder == null) {</span>
<span class="fc" id="L261">            newCache.remove(cacheKey);</span>
        } else {
<span class="fc" id="L263">            newCache.put(cacheKey, encoder);</span>
        }
<span class="fc" id="L265">        encoders = newCache;</span>
<span class="fc" id="L266">    }</span>

    public static boolean canCreate(Class clazz) {
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (objectFactories.containsKey(clazz)) {</span>
<span class="nc" id="L270">            return true;</span>
        }
<span class="fc bfc" id="L272" title="All 2 branches covered.">        for (Extension extension : getExtensions()) {</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">            if (extension.canCreate(clazz)) {</span>
<span class="fc" id="L274">                addObjectFactory(clazz, extension);</span>
<span class="fc" id="L275">                return true;</span>
            }
<span class="fc" id="L277">        }</span>
<span class="fc" id="L278">        return false;</span>
    }

    public static Object create(Class clazz) {
<span class="nc" id="L282">        return getObjectFactory(clazz).create(clazz);</span>
    }

    public static Extension getObjectFactory(Class clazz) {
<span class="fc" id="L286">        return objectFactories.get(clazz);</span>
    }

    private synchronized static void addObjectFactory(Class clazz, Extension extension) {
<span class="fc" id="L290">        HashMap&lt;Class, Extension&gt; copy = new HashMap&lt;Class, Extension&gt;(objectFactories);</span>
<span class="fc" id="L291">        copy.put(clazz, extension);</span>
<span class="fc" id="L292">        objectFactories = copy;</span>
<span class="fc" id="L293">    }</span>

    private static class TypeProperty {

        public final Type type;
        public final String property;

<span class="fc" id="L300">        private TypeProperty(Type type, String property) {</span>
<span class="fc" id="L301">            this.type = type;</span>
<span class="fc" id="L302">            this.property = property;</span>
<span class="fc" id="L303">        }</span>

        @Override
        public boolean equals(Object o) {
<span class="nc bnc" id="L307" title="All 2 branches missed.">            if (this == o) return true;</span>
<span class="nc bnc" id="L308" title="All 4 branches missed.">            if (o == null || getClass() != o.getClass()) return false;</span>

<span class="nc" id="L310">            TypeProperty that = (TypeProperty) o;</span>

<span class="nc bnc" id="L312" title="All 6 branches missed.">            if (type != null ? !type.equals(that.type) : that.type != null) return false;</span>
<span class="nc bnc" id="L313" title="All 4 branches missed.">            return property != null ? property.equals(that.property) : that.property == null;</span>
        }

        @Override
        public int hashCode() {
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">            int result = type != null ? type.hashCode() : 0;</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">            result = 31 * result + (property != null ? property.hashCode() : 0);</span>
<span class="fc" id="L320">            return result;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>